<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crescent House - Duty Display</title>
    <meta http-equiv="refresh" content="60">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // CONFIGURATION - Add your Google Sheets CSV URL here
        // Instructions:
        // 1. In Google Sheets, go to File ‚Üí Share ‚Üí Publish to web
        // 2. Choose the sheet/tab you want, select "Comma-separated values (.csv)"
        // 3. Click Publish and copy the URL here
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTaV5LO0lckYcYAl-2NV3kut2k7TKxezMG5n7Kql2iTTtcg7Q9Lj_MfEgHlk8Y0pybHHkSLLojxmS7S/pub?gid=0&single=true&output=csv';
        
        // Expected CSV format:
        // Name,Shift,Days
        // Alice Johnson,morning,"1,2,3"
        // Bob Smith,morning,"4,5"
        // David Wilson,evening,"1,4"
        // etc.
        
        // Shift time definitions (24-hour format)
        const shiftTimes = {
            morning: { start: 8, end: 17, label: "Day Shift", icon: "‚òÄÔ∏è" },        // 8am - 5pm
            evening: { start: 17, end: 23, label: "Evening Shift", icon: "üåÖ" },   // 5pm - 11pm
            night: { start: 23, end: 8, label: "Overnight Shift", icon: "üåô" }     // 11pm - 8am
        };

        let dutySchedule = {
            morning: [],
            evening: [],
            night: []
        };

        let currentTime = new Date();
        let currentShift = '';
        let dutyPerson = '';
        let isLoading = true;
        let errorMessage = '';

        function parseDays(daysString) {
            // Parse comma-separated days like "1,2,3" into array [1,2,3]
            return daysString.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const schedule = {
                morning: [],
                evening: [],
                night: []
            };
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Simple CSV parsing (handles quoted fields)
                const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                if (!matches || matches.length < 3) continue;
                
                const name = matches[0].replace(/^"|"$/g, '').trim();
                const shift = matches[1].replace(/^"|"$/g, '').trim().toLowerCase();
                const daysString = matches[2].replace(/^"|"$/g, '').trim();
                
                const days = parseDays(daysString);
                
                if (schedule[shift] && days.length > 0) {
                    schedule[shift].push({ name, days });
                }
            }
            
            return schedule;
        }

        async function loadScheduleFromGoogleSheets() {
            if (GOOGLE_SHEET_URL === 'YOUR_GOOGLE_SHEET_CSV_URL_HERE') {
                errorMessage = 'Please configure Google Sheets URL';
                isLoading = false;
                render();
                return;
            }
            
            try {
                // Use CORS proxy to bypass CORS restrictions when opening as local file
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(GOOGLE_SHEET_URL);
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch schedule');
                }
                
                const csvText = await response.text();
                dutySchedule = parseCSV(csvText);
                isLoading = false;
                errorMessage = '';
                updateDuty(currentTime);
                render();
            } catch (error) {
                console.error('Error loading schedule:', error);
                errorMessage = 'Error loading schedule from Google Sheets';
                isLoading = false;
                render();
            }
        }

        function getCurrentShift(date) {
            const hour = date.getHours();
            
            if (hour >= shiftTimes.morning.start && hour < shiftTimes.morning.end) {
                return 'morning';
            } else if (hour >= shiftTimes.evening.start && hour < shiftTimes.evening.end) {
                return 'evening';
            } else {
                return 'night';
            }
        }

        function updateDuty(date) {
            const shift = getCurrentShift(date);
            const dayOfWeek = date.getDay();
            
            currentShift = shift;
            
            const person = dutySchedule[shift].find(p => p.days.includes(dayOfWeek));
            dutyPerson = person ? person.name : 'No duty assigned';
        }

        function formatDate(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function render() {
            const shiftInfo = shiftTimes[currentShift];
            const timeString = currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let mainContent;
            
            if (isLoading) {
                mainContent = `
                    <div class="border-2 border-black p-12 text-center">
                        <div class="text-2xl">Loading schedule...</div>
                    </div>
                `;
            } else if (errorMessage) {
                mainContent = `
                    <div class="border-2 border-black p-12 text-center">
                        <div class="text-xl text-red-600 mb-4">‚ö†Ô∏è ${errorMessage}</div>
                        <div class="text-sm">Check the Google Sheets URL configuration</div>
                    </div>
                `;
            } else {
                mainContent = `
                    <!-- Shift Indicator -->
                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-2 text-xl font-semibold">
                            <span style="font-size: 24px;">${shiftInfo.icon}</span>
                            <span>${shiftInfo.label}</span>
                        </div>
                        <div class="text-sm opacity-60 mt-1">
                            ${timeString}
                        </div>
                    </div>

                    <!-- Main Display -->
                    <div class="border-2 border-black p-12 text-center">
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <span style="font-size: 32px;">üë§</span>
                            <span class="text-2xl font-semibold">ON DUTY:</span>
                        </div>
                        <div class="text-6xl font-bold mt-4">
                            ${dutyPerson}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-white text-black flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full border-4 border-black p-8">
                        <!-- Header -->
                        <div class="text-center mb-12">
                            <h1 class="text-4xl font-bold mb-2">CRESCENT HOUSE</h1>
                            <div class="flex items-center justify-center gap-2 text-lg">
                                <span>üïê</span>
                                <span>${formatDate(currentTime)}</span>
                            </div>
                        </div>

                        ${mainContent}

                        <!-- Shift Schedule Reference -->
                        <div class="mt-8 grid grid-cols-3 gap-4 text-xs border-t-2 border-black pt-6">
                            <div class="text-center">
                                <div class="flex items-center justify-center gap-1 font-semibold mb-1">
                                    <span>‚òÄÔ∏è</span>
                                    <span>Day</span>
                                </div>
                                <div class="opacity-60">8am - 5pm</div>
                            </div>
                            <div class="text-center">
                                <div class="flex items-center justify-center gap-1 font-semibold mb-1">
                                    <span>üåÖ</span>
                                    <span>Evening</span>
                                </div>
                                <div class="opacity-60">5pm - 11pm</div>
                            </div>
                            <div class="text-center">
                                <div class="flex items-center justify-center gap-1 font-semibold mb-1">
                                    <span>üåô</span>
                                    <span>Overnight</span>
                                </div>
                                <div class="opacity-60">11pm - 8am</div>
                            </div>
                        </div>

                        <!-- Footer Info -->
                        <div class="mt-6 text-center text-sm opacity-60">
                            <p>Display updates every minute</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function update() {
            currentTime = new Date();
            if (!isLoading && !errorMessage) {
                updateDuty(currentTime);
            }
            render();
        }

        // Initial render
        render();

        // Load schedule from Google Sheets
        loadScheduleFromGoogleSheets();

        // Update every minute (low power - infrequent updates)
        setInterval(update, 60000);
    </script>
</body>
</html>
